@{
    ViewData["Title"] = "TrangChờ";
    Layout = "~/Areas/XE/Views/Shared/_Layout.cshtml";
}
@model IEnumerable<BPVN_QL_XE_KTX_PH.Areas.XE.Controllers.XeController.DonViewModel>

<h2 style="text-align:center; margin-bottom:2rem; color:#1e4a8b;">📋 Danh sách đơn Chờ</h2>

<!-- Nút duyệt nhanh -->
<div style="text-align:center; margin-bottom:1.5rem;">
    <button id="duyetNhanhBtn"
            style="background:linear-gradient(90deg,#4a7ecb,#6a99e5); color:#fff; padding:10px 20px;
                   border:none; border-radius:8px; font-weight:bold; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.1);">
        ✅ Duyệt nhanh
    </button>
</div>

<!-- Lưới danh sách đơn có scroll -->
<div style="max-height:75vh; overflow-y:auto; padding-right:0.5rem; display:flex; flex-wrap:wrap; gap:1rem; justify-content:flex-start;">
    @foreach (var don in Model)
    {
        <div data-id="@don.IdDon"
             style="flex: 0 0 calc((100% - 5rem)/6);
                        box-sizing: border-box;
                        border:2px solid #ccc; border-radius:8px; padding:0.5rem;
                        background:#f9faff; box-shadow:0 4px 8px rgba(0,0,0,0.05);
                        cursor:pointer; display:flex; flex-direction:column; transition: transform 0.2s;">

            <!-- Checkbox chọn -->
            <div style="text-align:right; margin-bottom:0.3rem;">
                @if (don.TrangThai != "Đã duyệt")
                {
                    <input type="checkbox" class="chonDon" value="@don.IdDon"
                           style="width:95%; height:18px; cursor:pointer;" />
                }
            </div>

            <!-- Ảnh -->
            <div style="margin-bottom:0.3rem; text-align:center;">
                @if (don.Anh != null && don.Anh.Length > 0)
                {
                    var base64 = Convert.ToBase64String(don.Anh);
                    <img src="data:image/png;base64,@base64"
                         style="width:100%; height:100px; object-fit:cover; border-radius:4px; border:1px solid #ccc;" />
                }
                else
                {
                    <span style="color:#6c757d;">Chưa có ảnh</span>
                }
            </div>

            <!-- Thông tin -->
            <h5 style="margin:0 0 0.3rem 0; color:#1e4a8b; font-size:0.9rem;">@don.TieuDe</h5>
            <p style="margin:0.1rem 0; font-size:0.8rem;"><strong>Người tạo:</strong> @don.TenNguoiTao</p>
            <p style="margin:0.1rem 0; font-size:0.8rem;"><strong>Cổng:</strong> @don.CongVao</p>
            <p style="margin:0.1rem 0; font-size:0.8rem;"><strong>Bộ phận:</strong> @don.BoPhanDangKy</p>
            <p style="margin:0.1rem 0; font-size:0.8rem;"><strong>Thời gian tạo:</strong> @(don.NgayTao?.ToString("dd/MM/yyyy HH:mm") ?? "-")</p>

            <!-- Trạng thái -->
            <p style="margin:0.1rem 0; font-size:0.8rem;">
                <strong>Trạng thái:</strong>
                <span style="padding:0.2rem 0.4rem; border-radius:5px; font-weight:bold;
                                 background-color:@(don.TrangThai == "Đang chờ xét duyệt" ? "#fff3b3" : "#4caf50");
                                 color:@(don.TrangThai == "Đang chờ xét duyệt" ? "#333" : "#fff");">
                    @don.TrangThai
                </span>
            </p>

            <p style="margin:0.1rem 0; font-size:0.8rem;"><strong>Người duyệt:</strong> @(don.TenNguoiDuyet ?? "-")</p>

            <p style="margin:0.1rem 0; font-size:0.8rem;">
                <strong>Đơn nộp:</strong>
                <span style="padding:0.2rem 0.4rem; border-radius:5px; font-weight:bold;
                                 background-color:@(don.TrangThaiNhap == 1 ? "#4caf50" : "#fff3b3");
                                 color:@(don.TrangThaiNhap == 1 ? "#fff" : "#333");">
                    @(don.TrangThaiNhap == 1 ? "Đã nộp" : "Chưa nộp")
                </span>
            </p>

            <!-- File đính kèm -->
            <p style="margin:0.1rem 0; font-size:0.8rem;">
                <strong>File:</strong>
                @if (!string.IsNullOrEmpty(don.DuongDan))
                {
                    <a href="~/LuuDonXe/@don.DuongDan" target="_blank"
                       style="color:#4a7ecb; text-decoration:underline;">Có</a>
                }
                else
                {
                    <span style="color:#6c757d;">Không</span>
                }
            </p>
        </div>
    }
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            const duyetBtn = document.getElementById("duyetNhanhBtn");

            duyetBtn.addEventListener("click", function() {
                const selected = Array.from(document.querySelectorAll(".chonDon:checked"))
                                      .map(cb => parseInt(cb.value));

                if(selected.length === 0){
                    alert("Vui lòng chọn ít nhất một đơn để duyệt!");
                    return;
                }

                if(!confirm(`Bạn có chắc chắn muốn duyệt ${selected.length} đơn này không?`)) return;

                fetch("/DonXetDuyet/AddTrangCho", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(selected)
                })
                .then(res => res.json())
                .then(data => {
                    if(data.success){
                        alert(`Đã duyệt ${data.updatedCount} đơn thành công!`);
                        location.reload();
                    } else {
                        alert(data.message || "Duyệt nhanh thất bại!");
                    }
                })
                .catch(err => {
                    console.error(err);
                    alert("Có lỗi xảy ra!");
                });
            });

            document.querySelectorAll("[data-id]").forEach(card => {
                card.addEventListener("click", function(e) {
                    if(e.target.tagName.toLowerCase() === 'input') return;
                    const idDon = this.getAttribute("data-id");
                    window.open(`/DonXetDuyet/CTTrangDuyet/${idDon}`, '_blank');
                });
            });
        });
    </script>
}
