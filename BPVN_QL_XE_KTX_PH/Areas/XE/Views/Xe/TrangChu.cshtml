@{
    ViewData["Title"] = "TrangChu";
    Layout = "~/Areas/XE/Views/Shared/_Layout.cshtml";
}
@using static BPVN_QL_XE_KTX_PH.Areas.XE.Controllers.XeController
@model IEnumerable<DonViewModel>

@{
    var donsByDate = Model.OrderByDescending(d => d.NgayTao)
                          .GroupBy(d => d.NgayTao?.Date ?? DateTime.MinValue)
                          .ToList();

    var nguoiDuyetList = Model.Select(d => d.TenNguoiDuyet)
                              .Where(n => !string.IsNullOrEmpty(n))
                              .Distinct()
                              .OrderBy(n => n)
                              .ToList();

    var trangThaiList = Model.Select(d => d.TrangThai)
                             .Where(t => !string.IsNullOrEmpty(t))
                             .Distinct()
                             .ToList();
}

<h2 style="text-align:center;margin-bottom:2rem;color:#0d6efd;font-family:Segoe UI,sans-serif;">
    📄 Danh sách đơn đăng ký
</h2>

<div id="filterPanel" style="display:flex;flex-wrap:wrap;justify-content:center;gap:1rem;margin-bottom:2rem;width:95%;margin-left:auto;margin-right:auto;">
    <div>
        <label><strong>📅 Ngày tạo:</strong></label>
        <input type="date" id="filterDate" style="width:95%;padding:6px;border-radius:6px;border:1px solid #aaa;background:#f8f9fa;">
    </div>

    <div>
        <label><strong>👤 Người duyệt:</strong></label>
        <select id="filterNguoiDuyet" style="width:95%;padding:6px;border-radius:6px;border:1px solid #aaa;background:#f8f9fa;">
            <option value="">-- Tất cả --</option>
            @foreach (var nd in nguoiDuyetList)
            {
                <option value="@nd">@nd</option>
            }
        </select>
    </div>

    <div>
        <label><strong>🧾 Mã đơn:</strong></label>
        <input type="text" id="filterMaDon" placeholder="Nhập mã đơn..." style="width:95%;padding:6px;border-radius:6px;border:1px solid #aaa;background:#f8f9fa;">
    </div>

    <div>
        <label><strong>⚙️ Trạng thái:</strong></label>
        <select id="filterTrangThai" style="width:95%;padding:6px;border-radius:6px;border:1px solid #aaa;background:#f8f9fa;">
            <option value="">-- Tất cả --</option>
            @foreach (var tt in trangThaiList)
            {
                <option value="@tt">@tt</option>
            }
        </select>
    </div>

    <div style="display:flex;align-items:end;">
        <button id="btnReset" style="width:95%;padding:6px 12px;border-radius:6px;background:#0d6efd;color:#fff;border:none;cursor:pointer;">
            🔄 Xóa lọc
        </button>
    </div>
</div>

<div id="donGrid" style="display:flex;flex-direction:column;gap:1rem;align-items:center;width:95%;margin-left:auto;margin-right:auto;">
    @foreach (var group in donsByDate)
    {
        <div class="date-group" data-date="@group.Key.ToString("yyyy-MM-dd")" style="width:100%;text-align:center;margin:2rem 0 1rem;position:relative;">
            <hr style="border:none;border-top:1px solid #ccc;margin:0.5rem 0;">
            <span style="position:absolute;top:-0.75rem;left:50%;transform:translateX(-50%);background:#fff;padding:0 0.5rem;font-weight:bold;color:#0d6efd;">
                📅 @((group.Key == DateTime.MinValue) ? "Chưa xác định" : group.Key.ToString("dd/MM/yyyy"))
            </span>

            <div class="don-group" style="display:flex;flex-wrap:wrap;gap:1.5rem;justify-content:flex-start;">
                @foreach (var don in group)
                {
                    <div class="don-card"
                         data-id="@don.IdDon"
                         data-date="@don.NgayTao?.ToString("yyyy-MM-dd")"
                         data-nguoiduyet="@don.TenNguoiDuyet"
                         data-madon="@don.MaDon"
                         data-trangthai="@don.TrangThai"
                         style="flex:0 0 calc((100% - 4*1.5rem)/5);  /* 5 cột, 4 gaps 1.5rem */
                    display:flex;
                    flex-direction:column;
                    background:#ffffff;
                    border-radius:12px;
                    box-shadow:0 6px 20px rgba(0,0,0,0.1);
                    cursor:pointer;
                    overflow:visible;
                    position:relative;
                    transition:transform 0.3s,box-shadow 0.3s;">

                        <div style="position:absolute;top:-10px;left:-10px;
                    background:@(don.TrangThai == "Đang chờ xét duyệt" ? "#ff6b6b" : "#20c997");
                    color:#fff;font-weight:bold;padding:6px 12px;border-radius:8px;font-size:1.1rem;
                    z-index:10;box-shadow:0 2px 6px rgba(0,0,0,0.15);">
                            @don.CongVao
                        </div>

                        <div style="background:linear-gradient(90deg,
                    @(don.TrangThai == "Đang chờ xét duyệt" ? "#ff6b6b" : "#0dcaf0"),
                    @(don.TrangThai == "Đang chờ xét duyệt" ? "#ff8787" : "#38d9a9"));
                    color:#fff;font-weight:bold;text-align:center;padding:0.75rem;font-size:1.1rem;
                    border-top-left-radius:12px;border-top-right-radius:12px;">
                            @don.TieuDe
                        </div>

                        <div style="padding:1rem;flex:1;display:flex;flex-direction:column;gap:0.4rem;align-items:center;">
                            <div style="width:100%;text-align:center;margin-bottom:0.5rem;">
                                @if (don.Anh != null && don.Anh.Length > 0)
                                {
                                    var base64 = Convert.ToBase64String(don.Anh);
                                    <img src="data:image/png;base64,@base64" style="max-width:100%;max-height:120px;border-radius:8px;border:1px solid #ccc;object-fit:cover;" />
                                }
                                else
                                {
                                    <span style="color:#6c757d;">Chưa có ảnh</span>
                                }
                            </div>

                            <p style="margin:0;"><strong>Người tạo:</strong> <span style="color:#0d6efd;">@don.TenNguoiTao</span></p>
                            <p style="margin:0;"><strong>Bộ phận:</strong> <span style="color:#0d6efd;">@don.BoPhanDangKy</span></p>
                            <p style="margin:0;"><strong>Mã đơn:</strong> <span style="color:#0d6efd;">@don.MaDon</span></p>
                            <p style="margin:0;"><strong>Người duyệt:</strong> <span style="color:#0d6efd;">@(don.TenNguoiDuyet ?? "-")</span></p>
                            <p style="margin:0;"><strong>Thời gian tạo:</strong> <span style="color:#0d6efd;">@(don.NgayTao?.ToString("HH:mm") ?? "-")</span></p>
                            <p style="margin:0;">
                                <strong>Trạng thái:</strong>
                                <span style="display:inline-block;padding:0.25rem 0.5rem;border-radius:0.25rem;font-weight:bold;font-size:0.9rem;background-color:@(don.TrangThai == "Đang chờ xét duyệt" ? "#ff6b6b" : "#51cf66");color:#fff;">
                                    @don.TrangThai
                                </span>
                            </p>
                        </div>
                    </div>
                }
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        document.addEventListener("DOMContentLoaded",()=>{
            const cards=document.querySelectorAll(".don-card");
            const filterDate=document.getElementById("filterDate");
            const filterNguoiDuyet=document.getElementById("filterNguoiDuyet");
            const filterMaDon=document.getElementById("filterMaDon");
            const filterTrangThai=document.getElementById("filterTrangThai");
            const btnReset=document.getElementById("btnReset");

            cards.forEach(card=>{
                card.addEventListener("mouseover",()=>{card.style.transform="translateY(-5px)";card.style.boxShadow="0 8px 22px rgba(0,0,0,0.15)";});
                card.addEventListener("mouseout",()=>{card.style.transform="translateY(0)";card.style.boxShadow="0 6px 20px rgba(0,0,0,0.1)";});
                card.addEventListener("click",()=>{const id=card.getAttribute("data-id");if(id){window.open(`/DonXetDuyet/ChiTietDon/${id}`,'_blank');}});
            });

            [filterDate,filterNguoiDuyet,filterMaDon,filterTrangThai].forEach(el=>{el.addEventListener("input",applyFilters);el.addEventListener("change",applyFilters);});
            btnReset.addEventListener("click",()=>{filterDate.value="";filterNguoiDuyet.value="";filterMaDon.value="";filterTrangThai.value="";applyFilters();});

            function applyFilters(){
                const dateVal=filterDate.value.trim();
                const nguoiVal=filterNguoiDuyet.value.trim().toLowerCase();
                const maDonVal=filterMaDon.value.trim().toLowerCase().replace(/[^a-z0-9]/g,"");
                const trangThaiVal=filterTrangThai.value.trim().toLowerCase();

                cards.forEach(card=>{
                    const cDate=(card.getAttribute("data-date")||"").trim();
                    const cNguoi=(card.getAttribute("data-nguoiduyet")||"").toLowerCase();
                    const cMaDon=(card.getAttribute("data-madon")||"").toLowerCase().replace(/[^a-z0-9]/g,"");
                    const cTrangThai=(card.getAttribute("data-trangthai")||"").toLowerCase();
                    const match=(!dateVal||cDate===dateVal)&&(!nguoiVal||cNguoi.includes(nguoiVal))&&(!maDonVal||cMaDon.includes(maDonVal))&&(!trangThaiVal||cTrangThai.includes(trangThaiVal));
                    card.style.display=match?"flex":"none";
                });

                document.querySelectorAll(".date-group").forEach(group=>{
                    const visibleCards=group.querySelectorAll(".don-card[style*='display: flex']").length;
                    group.style.display=visibleCards>0?"block":"none";
                });
            }
        });
    </script>
}
